<ui:composition  xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions"
	locale="#{localeBean.usedLocale}" 
	xmlns:f="http://java.sun.com/jsf/core">
	<!-- 				<p:growl autoUpdate="true" id="growl1" showDetail="true" sticky="true" /> -->

	<h:form id="form">
		<h2 style="color: #007d4c;">PROSPECCIÓN > REQUERIMIENTO SEPARACIÓN</h2>
		<p:selectOneButton value="#{requerimientoSeparacionBean.estado}" unselectable="false">
			<f:selectItem itemLabel="Pendientes" itemValue="Pendiente"/>
			<f:selectItem itemLabel="Atendidos" itemValue="Atendido"/>
			<f:selectItem itemLabel="Rechazados" itemValue="Rechazado"/>
			
			<p:ajax update=":form:idTableReqsep :form:menuTableReq" />
		</p:selectOneButton>
		<p:dataTable var="req" id="idTableReqsep" value="#{requerimientoSeparacionBean.lstReqSepLazy}" rowIndexVar="row" paginator="true" rows="5" size="small" 
		emptyMessage="No se encontraron requerimientos de separación." paginatorPosition="bottom" rowKey="#{req.id}" selection="#{requerimientoSeparacionBean.requerimientoSeparacionSelected}" 
		selectionMode="single"> 
			<f:facet name="header">
				<div class="p-d-flex p-ai-center p-jc-between">
					<span>Lista de Requerimientos de Separación</span>
				</div>
			</f:facet>

			<p:column style="width:42px;text-align: left">
				<f:facet name="header">
				N°
				</f:facet>
			</p:column>

			<p:column width="25px">
                   		#{row +1}
     		</p:column>
     		
     		<p:column headerText="Prospecto" sortBy="#{req.prospection.prospect.person.surnames}"
				filterBy="#{req.prospection.prospect.person.surnames}" filterMatchMode="contains">
				<h:outputText value="#{req.prospection.prospect.person.surnames} #{req.prospection.prospect.person.names}" />
			</p:column>
			
			<p:column headerText="Asesor" sortBy="#{req.prospection.personAssessor.surnames}"
				filterBy="#{req.prospection.personAssessor.surnames}" filterMatchMode="contains">
				<h:outputText value="#{req.prospection.personAssessor.surnames} #{req.prospection.personAssessor.names}" />
			</p:column>
			
			<p:column headerText="Supervisor" sortBy="#{req.prospection.personSupervisor.surnames}"
				filterBy="#{req.prospection.personSupervisor.surnames}" filterMatchMode="contains">
				<h:outputText value="#{req.prospection.personSupervisor.surnames} #{req.prospection.personSupervisor.names}" />
			</p:column>

			<p:column headerText="Proyecto" sortBy="#{req.lote.project.name}" filterMatchMode="contains">
				<h:outputText value="#{req.lote.project.name}" />
			</p:column>
			
			<p:column headerText="Manzana" sortBy="#{req.lote.manzana.name}" filterMatchMode="contains">
				<h:outputText value="#{req.lote.manzana.name}" />
			</p:column>
			
			<p:column headerText="Lote" sortBy="#{req.lote.numberLote}" filterMatchMode="contains">
				<h:outputText value="#{req.lote.numberLote}" />
			</p:column>
			
			<p:column headerText="Estado" sortBy="#{req.estado}" filterMatchMode="contains">
				<h:outputText value="#{req.estado}" />
			</p:column>
			
			<p:column headerText="Fecha Requerimiento" sortBy="#{req.fecha}" filterMatchMode="contains">
				<h:outputText value="#{prospeccionBean.convertirHora(req.fecha)}" />
			</p:column>
			
			<p:column headerText="Fecha Separación" sortBy="#{req.lote.fechaSeparacion}" filterMatchMode="contains">
				<h:outputText value="#{req.lote.fechaSeparacion}" > 
					<f:convertDateTime pattern="dd/MM/yyyy" />
				</h:outputText>
			</p:column>
			
			<p:column headerText="Fecha Vencimiento" sortBy="#{req.lote.fechaSeparacion}" filterMatchMode="contains">
				<h:outputText value="#{req.lote.fechaSeparacion}" > 
					<f:convertDateTime pattern="dd/MM/yyyy" />
				</h:outputText>
			</p:column>
			
			<p:column width="10%" headerText="Voucher" filterMatchMode="contains">
				<p:commandButton value="VER" oncomplete="PF('dlg').show()" update=":idFormImagen" process="@this :idFormImagen:tvVoucher:imagenLoad" actionListener="#{requerimientoSeparacionBean.botonVer}">
					<f:setPropertyActionListener value="#{req.nombreImagen}" target="#{loadImageBean.nombreArchivo}"  />
					<f:setPropertyActionListener value="#{req}" target="#{requerimientoSeparacionBean.requerimientoSeparacionSelected}"  />
				</p:commandButton>
			</p:column>
			
		</p:dataTable>
		
		<p:contextMenu id="menuTableReq" for="idTableReqsep" >
            <p:menuitem value="Ejecutar" icon="pi pi-check" action="#{requerimientoSeparacionBean.modifyRequerimiento}" oncomplete="PF('dialogRequerimiento').show()" rendered="#{requerimientoSeparacionBean.estado eq 'Aprobado Contabilidad' and requerimientoSeparacionBean.ejecutaRequerimiento and requerimientoSeparacionBean.cantidad ne 0}" />
            <p:menuitem value="Rechazar" icon="pi pi-times" oncomplete="PF('rechazaConta').show()" rendered="#{(requerimientoSeparacionBean.estado eq 'Pendiente' and requerimientoSeparacionBean.apruebaConta and requerimientoSeparacionBean.cantidad ne 0)  or (requerimientoSeparacionBean.estado eq 'Aprobado Contabilidad' and requerimientoSeparacionBean.ejecutaRequerimiento and requerimientoSeparacionBean.cantidad ne 0)}"/>
        </p:contextMenu>
		
	</h:form>
	
	<p:dialog modal="true" dynamic="true" closeOnEscape="true" id="idImg" header="Voucher" widgetVar="dlg" resizable="false" closable="true"
		appendTo="@(body)" >	
		<h:form id="idFormImagen"> 
			<p:tabView id="tvVoucher"> 
				<p:tab title="Voucher" > 
					<p:graphicImage width="400"  value="#{loadImageBean.image}" id="imagenLoad" cache="false"/>
				</p:tab>
				<p:tab id="tabReg" title="Registrar Voucher" rendered="#{requerimientoSeparacionBean.estado eq 'Pendiente'}"> 
					
					<h:panelGrid id="grid" columns="4">
						<h:outputLabel  value="Cuenta Bancaria:" />
						<p:selectOneMenu value="#{requerimientoSeparacionBean.cuentaBancariaSelected}" converter="#{requerimientoSeparacionBean.conversorCuentaBancaria}" >
		                    <f:selectItem itemLabel="[-- Ninguno --]" itemValue="#{null}"/>
		                    <f:selectItems value="#{requerimientoSeparacionBean.lstCuentaBancaria}" var="cb" itemLabel="#{cb.banco.abreviatura} : #{cb.numero}  (#{cb.moneda eq 'D'?'Dólares':'Soles'})" itemValue="#{cb}"/>
		                	<p:ajax update=":idFormImagen:tvVoucher:gridBot" listener="#{requerimientoSeparacionBean.ocultarBotonAprobar}"/>
		                </p:selectOneMenu>
						
						<h:outputLabel value="Monto:" />
						<p:inputNumber value="#{requerimientoSeparacionBean.monto}" modifyValueOnWheel="false"> 
						<p:ajax update=":idFormImagen:tvVoucher:gridBot" listener="#{requerimientoSeparacionBean.ocultarBotonAprobar}"/> 
						</p:inputNumber>
						
						<h:outputLabel value="Tipo de transacción: " />
						<p:selectOneMenu id="tipo" value="#{requerimientoSeparacionBean.tipoTransaccion}" >
							<f:selectItem itemLabel="[- Seleccionar -]" itemValue=""/>
							<f:selectItem itemLabel="DEPOSITO EN EFECTIVO" itemValue="DEPOSITO EN EFECTIVO"/>
							<f:selectItem itemLabel="TRASFERENCIAS ENTRE TERCEROS" itemValue="TRASFERENCIAS ENTRE TERCEROS"/>
							<f:selectItem itemLabel="TRASFERENCIA INTERBANCARIA" itemValue="TRASFERENCIA INTERBANCARIA"/>
							<p:ajax update=":idFormImagen:tvVoucher:gridBot" listener="#{requerimientoSeparacionBean.ocultarBotonAprobar}"/>
						</p:selectOneMenu>
						
						<h:outputLabel value="Nro. transacción:" />
						<p:inputText value="#{requerimientoSeparacionBean.numeroTransaccion}"> 
							<p:ajax update=":idFormImagen:tvVoucher:gridBot" listener="#{requerimientoSeparacionBean.ocultarBotonAprobar}"/>
						</p:inputText>
						
						<h:outputLabel value="Fecha Operación:" />
						<p:datePicker value="#{requerimientoSeparacionBean.fechaOperacion}"  showTime="true" style="margin:5px" pattern="dd/MM/yyyy hh:mm:ss a" readonlyInput="true"> 
							<p:ajax update=":idFormImagen:tvVoucher:gridBot" listener="#{requerimientoSeparacionBean.ocultarBotonAprobar}"/>
						</p:datePicker>
						
						
					</h:panelGrid>
					
					<h:panelGrid id="gridBot" columns="2">
					
						<p:commandButton value="Validar" actionListener="#{requerimientoSeparacionBean.validar}" process="@this"  update=":idFormImagen:tvVoucher:gridBot"/>
						<p:commandButton id="btnAproConta" update=":form:idTableReqsep :form:menuTableReq" oncomplete="PF('dlg').hide();" value="Aprobar" actionListener="#{requerimientoSeparacionBean.aprobar}" rendered="#{requerimientoSeparacionBean.mostrarBoton}" process="@this" />
					
					</h:panelGrid>

				</p:tab>
			</p:tabView>
			
		</h:form>
    </p:dialog>
	
	<p:dialog modal="true" dynamic="true" closeOnEscape="true" id="dialogReqSep" header="Ejecutar" widgetVar="dialogRequerimiento" resizable="false" closable="true"
		appendTo="@(body)" >
		<h:form id="formRequerimiento" >
		
		<h:panelGrid id="grid" columns="2"> 
			<h:outputLabel value="Fecha de separación: "/>
			<p:datePicker value="#{requerimientoSeparacionBean.fechaSeparacion}" > 
			</p:datePicker>
						
		
			<h:outputLabel  value="Fecha de vencimiento "/>
			<p:datePicker value="#{requerimientoSeparacionBean.fechaVencimiento}"> 
			</p:datePicker>	
			
		</h:panelGrid>
		<p:commandButton value="Guardar" action="#{requerimientoSeparacionBean.ejecutarRequerimiento}" update="form:idTableReqsep"/>
			
		</h:form>
	</p:dialog>
    
    <p:confirmDialog id="rechazaConta" message="¿Está seguro de rechazar el requerimiento de separación?" header="Confirmación"
                      severity="alert" widgetVar="rechazaConta" appendTo="@(body)">
        <h:form >
            <p:commandButton onstart="PF('blockUIWidget').block();" oncomplete="PF('blockUIWidget').unblock();PF('rechazaConta').hide()" value="SI" update=":form:idTableReqsep" action="#{requerimientoSeparacionBean.rechazarRequerimiento}"/>
            <p:commandButton value="NO" oncomplete="PF('rechazaConta').hide()"/>
        </h:form>
    </p:confirmDialog>
    
    <pe:blockUI widgetVar="blockUIWidget">
          <h:form style="background: white"> 
          <h:outputText value="Cargando, espere..." style="white-space: nowrap; font-weight:bold; color: #036fab; background: white"/> 
          </h:form>
        
    </pe:blockUI>

</ui:composition>