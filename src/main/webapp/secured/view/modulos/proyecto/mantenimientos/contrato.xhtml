<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions"
	locale="#{localeBean.usedLocale}"
	xmlns:f="http://java.sun.com/jsf/core">


	<h:form id="form" style="font-size: 11px;">  
		<h2 style="color: #007d4c;">PROYECTOS > CONTRATOS</h2>
		<p:tabView id="tabView" style="font-size: 14px;">
			<p:tab title="Lista de Contratos" style="font-size: 11px;">
				<p:selectOneButton value="#{contratoBean.estado}" unselectable="false">
					<f:selectItem itemLabel="Activos" itemValue="#{true}" />
					<f:selectItem itemLabel="Anulados" itemValue="#{false}" />
					<p:ajax  update="idTableContrato"/>
				</p:selectOneButton> 
				
                <p:commandButton value="ACTUALIZAR" style="display:none;" onclick="PrimeFaces.monitorDownload(start, stop);" id="btnAct" styleClass="ui-button-success" icon="pi pi-check"> 
                	<p:fileDownload value="#{contratoBean.fileDes}"/> 
                </p:commandButton>
				
				<p:dataTable var="contrato" id="idTableContrato" value="#{contratoBean.lstContratoLazy}" widgetVar="contratoTable" rowIndexVar="row" paginator="true" rows="15" size="small"
				emptyMessage="No se encontraron contratos."	paginatorPosition="bottom" rowKey="#{contrato.id}"  selectionMode="single" selection="#{contratoBean.contratoSelected}">
				
					<f:facet name="header">
						<div class="p-d-flex p-ai-center p-jc-between">
							<span>Lista de Contratos</span>
						</div>
					</f:facet>
		
					<p:column width="25px">
			                      #{row +1}
			        </p:column>
			        
			        <p:column headerText="Fecha Venta" filterMatchMode="contains" sortBy="#{contrato.fechaVenta}">
						<h:outputText value="#{contrato.fechaVenta}">
							<f:convertDateTime pattern="dd/MM/yyyy" />
						</h:outputText>
					</p:column>
			        
					<p:column headerText="Monto Venta" filterMatchMode="contains">
						<h:outputText value="#{contrato.montoVenta}"> 
							<f:convertNumber type="currency" currencySymbol="S/"/>
						</h:outputText>
					</p:column>
					
					<p:column headerText="Tipo Pago" filterMatchMode="contains">
						<h:outputText value="#{contrato.tipoPago}"/>
					</p:column>
					
					<p:column headerText="Monto Inicial" filterMatchMode="contains">
						<h:outputText value="#{contrato.montoInicial}"> 
							<f:convertNumber type="currency" currencySymbol="S/"/>
						</h:outputText>
					</p:column>
					
					<p:column headerText="Número Cuotas" filterMatchMode="contains">
						<h:outputText value="#{contrato.numeroCuota}"/>
					</p:column>
					
					<p:column headerText="Interés" filterMatchMode="contains">
						<h:outputText value="#{contrato.interes}#{contrato.interes eq null?'':'%'}">  
							<f:convertNumber type="currency" currencySymbol=""/>
						</h:outputText>
					</p:column>
					
					<p:column headerText="Fecha 1ra Cuota" filterMatchMode="contains">
						<h:outputText value="#{contrato.fechaPrimeraCuota}">
							<f:convertDateTime pattern="dd/MM/yyyy" />
						</h:outputText>
					</p:column>
					
					<p:column headerText="Persona Venta 1" filterMatchMode="contains">
						<h:outputText value="#{contrato.personVenta.surnames} #{contrato.personVenta.names}"/>
					</p:column>
					
					<p:column headerText="Persona Venta 2" filterMatchMode="contains">
						<h:outputText  value="#{contrato.personVenta2.surnames} #{contrato.personVenta2.names}"/>
					</p:column>
					
					<p:column headerText="Persona Venta 3" filterMatchMode="contains">
						<h:outputText  value="#{contrato.personVenta3.surnames} #{contrato.personVenta3.names}"/>
					</p:column>
					
					<p:column headerText="Persona Venta 4" filterMatchMode="contains">
						<h:outputText  value="#{contrato.personVenta4.surnames} #{contrato.personVenta4.names}"/>
					</p:column>
					
					<p:column headerText="Persona Venta 5" filterMatchMode="contains">
						<h:outputText  value="#{contrato.personVenta5.surnames} #{contrato.personVenta5.names}"/>
					</p:column>
					
					<p:column width="10%" headerText="Firma" filterMatchMode="contains">
						<p:commandButton id="botonFirma" update=":form:tabView:idTableContrato:botonFirma" value="#{contrato.firma eq true?'FIRMADO':'NO FIRMADO'}" action="#{contratoBean.cambiarEstadoFirma(contrato)}" styleClass="#{contrato.firma eq true? 'ui-button-success' : 'ui-button-warning'}"/>
					</p:column>
					
				</p:dataTable>
				
				<p:contextMenu id="menuTableReq" for="idTableContrato" >
		            <p:menuitem value="Descargar Contrato" icon="pi pi-check" action="#{contratoBean.generarExcel}" oncomplete="hacerClick('#{p:resolveFirstComponentWithId('btnAct', view).clientId}');"  />
		            <p:menuitem value="Anular" icon="pi pi-trash" oncomplete="PF('anulaContra').show()"  />		        
		        	<p:menuitem value="Ver Cronograma de Pago" icon="pi pi-search-plus" action="#{contratoBean.verCronogramaPago()}" oncomplete="PF('cronogramaPagoDialog').show();" update="dialogCronogramaPago"  />		        
		        	<p:menuitem value="Añadir Observación" icon="pi pi-comments" action="#{contratoBean.cargarListaObservacion()}" oncomplete="PF('añadirObservacionDialog').show();" update="dialogAñadirObservacion"  />		        
		        
		        </p:contextMenu>
			</p:tab>
			<p:tab title="Nuevo Contrato"  style="font-size: 11px;">
			
				<h:panelGrid columns="5" id="gridNomLote"> 
					<p:commandButton id="movieBtn" style="font-size: 14px;" value="Importar Lote" icon="pi pi-search" actionListener="#{contratoBean.listarLotesSinContrato}" update=":form:tabView:tableLote"/>
					<p:overlayPanel for="movieBtn" dynamic="true" style="width:600px" widgetVar="moviePicker">
						<p:dataTable var="lote" value="#{contratoBean.lstLotesSinContrato}" rows="5" paginator="true" selectionMode="single" rowIndexVar="row" paginatorPosition="bottom" 
							selection="#{contratoBean.loteSelected}" rowKey="#{lote.id}" id="tableLote" emptyMessage="No se encontraron resultados" size="small">
							<p:ajax event="rowSelect" listener="#{contratoBean.seleccionarLote()}" oncomplete="PF('moviePicker').hide()" update=":form:tabView:gridNomLote :form:tabView:grid  "/>
	
							<p:column headerText="Proyecto" >
								<h:outputText value="#{lote.project.name}" style="font-size: 14px;"/>
							</p:column>
	
							<p:column headerText="Nro. Lote" style="text-align:center">
								<h:outputText value="#{lote.numberLote}" style="font-size: 14px;"/>
							</p:column>
	
							<p:column headerText="Manza" style="text-align:center">
								<h:outputText value="#{lote.manzana.name}" style="font-size: 14px;"/>
							</p:column>
							
							<p:column headerText="Tipo Pago" style="text-align:center">
								<h:outputText value="#{lote.tipoPago}" style="font-size: 14px;"/>
							</p:column>
							<p:column headerText="Fecha Venta" style="text-align:center">
								<h:outputText value="#{lote.fechaVendido}" style="font-size: 14px;"> 
									<f:convertDateTime pattern="dd/MM/yyyy" />
								</h:outputText>
							</p:column>
							
						</p:dataTable>
					</p:overlayPanel>
				
				
					<h:outputText value="Lote: " style="font-size: 20px;font-weight: bolder;" rendered="#{contratoBean.loteSelected ne null}"/>
					<h:outputText value="#{contratoBean.nombreLoteSelected}" style="font-size: 20px;color:#007d4c;font-weight: bolder;" rendered="#{contratoBean.loteSelected ne null}"/>
					
					<p:commandLink actionListener="#{contratoBean.eliminarLoteSelected}" update=":form:tabView:gridNomLote :form:tabView:grid" title="ELIMINAR" >
                        <p:graphicImage value="/recursos/images/eliminar.gif" rendered="#{contratoBean.loteSelected ne null}" />
                    </p:commandLink>
				</h:panelGrid>
				
				<h:panelGrid id="grid" columns="4" > 				
					
					<h:outputLabel  value="Fecha de venta: " />
					<p:datePicker  value="#{contratoBean.fechaVenta}" style="margin:5px; width:220px" />
					
					<h:outputLabel  value="Monto de venta: " />
					<p:inputNumber  value="#{contratoBean.montoVenta}" style="margin:5px; width:220px" />
					
					<h:outputLabel value="Tipo de Pago:"  />
					<p:selectOneMenu  value="#{contratoBean.tipoPago}" style="margin:5px; width:220px" >
						<f:selectItem itemLabel="Contado" itemValue="Contado" />
						<f:selectItem itemLabel="Crédito" itemValue="Crédito"/>
						<p:ajax listener="#{contratoBean.cambiarTipoPago}" update=":form:tabView:grid" />
					</p:selectOneMenu>
										
					<h:outputLabel value="Monto Inicial: " id="lblMontoInicial" rendered="#{contratoBean.tipoPago eq 'Crédito'}" />
					<p:inputNumber id="nbrMontoInicial" value="#{contratoBean.montoInicial}" style="margin:5px; width:220px" modifyValueOnWheel="false" rendered="#{contratoBean.tipoPago eq 'Crédito'}"/> 
										
					<h:outputLabel value="Nro. de Cuotas: " id="lblNroCuota"  rendered="#{contratoBean.tipoPago eq 'Crédito'}"/>
					<p:inputNumber  value="#{contratoBean.nroCuotas}" style="margin:5px; width:220px"  decimalPlaces="0" rendered="#{contratoBean.tipoPago eq 'Crédito'}"/> 
				
					<h:outputLabel value="Interés:" id="lblInteres"  rendered="#{contratoBean.tipoPago eq 'Crédito'}"/>
					<p:inputNumber value="#{contratoBean.interes}" style="margin:5px; width:220px" rendered="#{contratoBean.tipoPago eq 'Crédito'}"/>
					
					<h:outputLabel value="Fecha de 1ra Cuota: " rendered="#{contratoBean.tipoPago eq 'Crédito'}"/>
					<p:datePicker value="#{contratoBean.fechaPrimeraCuota}" style="margin:5px; width:220px" rendered="#{contratoBean.tipoPago eq 'Crédito'}"/>
					
					<h:outputLabel value="Persona de venta 1: " />
					<p:autoComplete scrollHeight="300" styleClass="ui-autocompV" value="#{contratoBean.persona1}" converter="#{contratoBean.conversorPersonSurnames}"  
					completeMethod="#{contratoBean.completePersonSurnames}"  var="per" itemLabel="#{per.surnames.concat(' ')}#{per.names}" itemValue="#{per}" forceSelection="true" style="margin:5px; width:220px"  />
		             
					<h:outputLabel value="Persona de venta 2: " />
					<p:autoComplete scrollHeight="300" styleClass="ui-autocompV" value="#{contratoBean.persona2}" converter="#{contratoBean.conversorPersonSurnames}"  
					completeMethod="#{contratoBean.completePersonSurnames}"  var="per" itemLabel="#{per.surnames.concat(' ')}#{per.names}" itemValue="#{per}" forceSelection="true" style="margin:5px; width:220px"  />
		                
		            <h:outputLabel  value="Persona de venta 3: " />
					<p:autoComplete scrollHeight="300" styleClass="ui-autocompV" value="#{contratoBean.persona3}" converter="#{contratoBean.conversorPersonSurnames}" 
					completeMethod="#{contratoBean.completePersonSurnames}" var="per" itemLabel="#{per.surnames.concat(' ')}#{per.names}" itemValue="#{per}" forceSelection="true" style="margin:5px; width:220px" />
		                
					<h:outputLabel  value="Persona de venta 4: " />
					<p:autoComplete scrollHeight="300" styleClass="ui-autocompV" value="#{contratoBean.persona4}" converter="#{contratoBean.conversorPersonSurnames}" 
					completeMethod="#{contratoBean.completePersonSurnames}" var="per" itemLabel="#{per.surnames.concat(' ')}#{per.names}" itemValue="#{per}" forceSelection="true" style="margin:5px; width:220px"  />
					
					<h:outputLabel  value="Persona de venta 5: " />
					<p:autoComplete scrollHeight="300" styleClass="ui-autocompV" value="#{contratoBean.persona5}" converter="#{contratoBean.conversorPersonSurnames}" 
					completeMethod="#{contratoBean.completePersonSurnames}" var="per" itemLabel="#{per.surnames.concat(' ')}#{per.names}" itemValue="#{per}" forceSelection="true" style="margin:5px; width:220px"  />


					<p:commandButton value="Guardar" oncomplete="PF('saveContra').show()"  style="margin-right:10px"/> 
					<p:commandButton id="btnCuotas" value="Ver Cuotas"   actionListener="#{contratoBean.botonVerCuota(false,null)}" oncomplete="mostrarSimulacion(xhr, status, args)"  update="dialogSimulador" rendered="#{contratoBean.tipoPago eq 'Crédito' and contratoBean.loteSelected ne null}"/> 
					

				</h:panelGrid>
				
				
			</p:tab>
		</p:tabView>
	</h:form>
	
	<p:dialog modal="true" height="600px" dynamic="true" closeOnEscape="true" id="dialogSimulador" header="Cronograma de pagos" widgetVar="cronogramaDialog" resizable="false" closable="true"
		appendTo="@(body)"  width="50%">
		<h:form id="formCronogramaDialog">
			<p:dataTable var="cuota" value="#{contratoBean.lstSimuladorPrevio}"  paginator="true" selectionMode="single" rowIndexVar="row" paginatorPosition="bottom" 
				 emptyMessage="No se encontraron resultados" size="small" rowKey="#{cuota.nroCuota}">

				<p:column headerText="Nro Cuota" style="text-align:center">
					<h:outputText value="#{cuota.nroCuota}" style="font-size: 14px;"/>
				</p:column>

				<p:column headerText="Periodo" style="text-align:center">
					<h:outputText value="#{cuota.fechaPago}" style="font-size: 14px;"> 
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>
				</p:column>
				
				<p:column  headerText="Cuota Inicial" >
				S/
					<h:outputText   value="#{cuota.inicial}" style="font-size: 14px;"> 
						<f:convertNumber type="currency" currencySymbol=""  />
					</h:outputText>
				</p:column>
				
				<p:column headerText="Cuota SI" style="text-align:center">
				S/
					<h:outputText value="#{cuota.cuotaSI}" style="font-size: 14px;"> 
						<f:convertNumber type="currency" currencySymbol=""/>
					</h:outputText>
				</p:column>
				
				<p:column headerText="Interés" style="text-align:center">
				S/
					<h:outputText value="#{cuota.interes}" style="font-size: 14px;"> 
						<f:convertNumber type="currency" currencySymbol=""/>
					</h:outputText>
				</p:column>
				
				<p:column headerText="Cuota Total" style="text-align:center">
				S/
					<h:outputText value="#{cuota.cuotaTotal}" style="font-size: 14px;"> 
						<f:convertNumber type="currency" currencySymbol=""/>
					</h:outputText>
				</p:column>
				
				
			</p:dataTable>
		</h:form>
	</p:dialog>
	
	<p:dialog modal="true" height="600px" dynamic="true" closeOnEscape="true" id="dialogCronogramaPago" header="Cronograma de pagos" widgetVar="cronogramaPagoDialog" resizable="false" closable="true"
		appendTo="@(body)"  width="50%">
		<h:form id="formCronogramaPagoDialog">
			
			<h:panelGrid columns="2"> 
				<h:outputText value="Total Cuota S.I.:" style="font-weight: bold;"/> 
				<h:outputText value="#{contratoBean.sumaCuotaSI}"> 
					<f:convertNumber type="currency" currencySymbol=""/>
				</h:outputText> 
				
				<h:outputText value="Total Interés:" style="font-weight: bold;"/> 
				<h:outputText value="#{contratoBean.sumaInteres}"> 
					<f:convertNumber type="currency" currencySymbol=""/>
				</h:outputText>
				
				<h:outputText value="Total Cuota Total:" style="font-weight: bold;"/> 
				<h:outputText value="#{contratoBean.sumaCuotaTotal}"> 
					<f:convertNumber type="currency" currencySymbol=""/>
				</h:outputText> 
			</h:panelGrid>
							
					 
			<p:commandButton value="Descargar" icon="pi pi-file-pdf" action="#{contratoBean.generarPdfCronograma()}" ajax="false" /> 
	
			<p:dataTable var="cuotaContrato" value="#{contratoBean.lstCuotaVista}" rows="24" paginator="true" selectionMode="single" rowIndexVar="row"  
					paginatorPosition="bottom"  rowKey="#{cuotaContrato.id}" id="tableCuotaContrato" editable="true" editMode="cell"
					emptyMessage="No se encontraron cronograma de deudas." size="small">
					
					<p:ajax event="cellEdit" listener="#{contratoBean.onCellEdit}" />

					<f:facet name="header">
						<div class="p-d-flex p-ai-center p-jc-between">
							<span>CRONOGRAMA DE LA DEUDA</span>
						</div>
					</f:facet>   
	
					<p:column headerText="Nro Cuota" filterMatchMode="contains" >
						<h:outputText  value="#{cuotaContrato.prepago eq true ? 'Prepago' : cuotaContrato.nroCuota}" style="font-weight: bold;color:#{cuotaContrato.prepago eq true ?'green':'black'}"/>
					</p:column>
					
					<p:column  headerText="Periodo" filterMatchMode="contains">
		                <p:cellEditor>
		                    <f:facet name="output">
		                       	<h:outputText value="#{cuotaContrato.fechaPago}" style="font-weight: bold;color:#{cuotaContrato.prepago eq true ?'green':'black'}"> 
		        			<f:convertDateTime pattern="dd/MM/yyyy" />
		        		</h:outputText>
		                    </f:facet>
		                    <f:facet name="input">
		                        <p:datePicker value="#{cuotaContrato.fechaPago}" />
		                    </f:facet>
		                </p:cellEditor>
	                </p:column>
				
					<p:column headerText="Cuota SI" filterMatchMode="contains" >
						<h:outputText  value="#{cuotaContrato.cuotaSI}" style="font-weight: bold;color:#{cuotaContrato.prepago eq true ?'green':'black'}"> 
							<f:convertNumber type="currency" currencySymbol=""/>
						</h:outputText>
					</p:column>
					
					<p:column headerText="Interés" filterMatchMode="contains" >
						<h:outputText  value="#{cuotaContrato.interes}" style="font-weight: bold;color:#{cuotaContrato.prepago eq true ?'green':'black'}"> 
							<f:convertNumber type="currency" currencySymbol=""/>
						</h:outputText>
					</p:column>
					
					<p:column headerText="Cuota Total" filterMatchMode="contains" >
						<h:outputText value="#{cuotaContrato.cuotaTotal}" style="font-weight: bold;color:#{cuotaContrato.prepago eq true ?'green':'black'}"> 
							<f:convertNumber type="currency" currencySymbol=""/>
						</h:outputText>
					</p:column>
					
					<p:column headerText="Estado de Pago" filterMatchMode="contains" >
						<h:outputText value="#{cuotaContrato.prepago eq true ? 'PREPAGO' : cuotaContrato.pagoTotal eq 'S'?'PAGADO':'PENDIENTE'}"  style="font-weight: bold;color:#{cuotaContrato.prepago eq true ?'green':cuotaContrato.pagoTotal eq 'S'?'blue':cuotaContrato.pagoTotal eq 'N'?'red':'black'}"/>
						
					</p:column>
	
				</p:dataTable>
		</h:form>
	</p:dialog>
	
	<p:dialog modal="true" height="600px" dynamic="true" closeOnEscape="true" id="dialogAñadirObservacion" header="Observaciones del Contrato" widgetVar="añadirObservacionDialog" resizable="false" closable="true"
		appendTo="@(body)"  width="50%">
		<h:form id="formAñadirObservacionDialog">
			<h:panelGrid id="idPanelObs" columns="1" width="100%">
				<p:inputTextarea value="#{contratoBean.observacion}" style="width:100%" rows="2" cols="30" counter="display" maxlength="500"
	                         counterTemplate="{0} caracteres restantes." autoResize="false"/>
	        	<h:outputText id="display" class="block" />
	        	
	        	<p:commandButton value="Añadir" action="#{contratoBean.anadirObsContrato()}" update="idObsContrato idPanelObs" />
        	</h:panelGrid>
        	
        	<p:dataTable var="observacion" id="idObsContrato" value="#{contratoBean.lstObservacionContrato}"  rowIndexVar="row" paginator="true" rows="5" 
				size="small" emptyMessage="No se encontratos resultados." paginatorPosition="bottom" rowKey="#{observacion.id}" selectionMode="single">
				
				<p:column width="25px">
	                      #{row +1}
	        	</p:column>
	        	
				<p:column headerText="Observación"  >
					<h:outputText value="#{observacion.observacion}" />
				</p:column>
				
				<p:column headerText="Usuario" filterMatchMode="contains" style="text-align: center; width:50px">
					<h:outputText value="#{observacion.usuario.username}" />
				</p:column>
				
				<p:column headerText="Fecha Registro" filterMatchMode="contains" style="text-align: center; width:80px">
					<h:outputText value="#{observacion.fechaRegistro}">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>
				</p:column>
				
				<p:column width="10%" filterMatchMode="contains">
					<p:commandButton icon="pi pi-trash" styleClass="rounded-button ui-button-danger" process="@this" oncomplete="PF('deleteObsDialog').show()" >
						<f:setPropertyActionListener value="#{observacion}" target="#{contratoBean.obsSelected}"  />
					</p:commandButton>
				</p:column>
				
			</p:dataTable>
			
		</h:form>
	</p:dialog>
	
	<p:confirmDialog id="anulaContra" message="¿Está seguro de anular el cotrato?" header="Confirmación"
                      severity="alert" widgetVar="anulaContra" appendTo="@(body)">
        <h:form >
            <p:commandButton onstart="PF('blockUIWidget').block();" oncomplete="PF('blockUIWidget').unblock();PF('anulaContra').hide()" value="SI" action="#{contratoBean.anularContrato}" update=":form:tabView:idTableContrato"/>
            <p:commandButton value="NO" oncomplete="PF('anulaContra').hide()"/>
        </h:form>
    </p:confirmDialog>
    
   
    
    <p:confirmDialog id="saveContra" message="¿Está seguro de guardar el cotrato?" header="Confirmación"
                      severity="alert" widgetVar="saveContra" appendTo="@(body)">
        <h:form >
            <p:commandButton onstart="PF('blockUIWidget').block();" oncomplete="PF('blockUIWidget').unblock();PF('saveContra').hide()" value="SI" actionListener="#{contratoBean.saveContrato()}" update=":form:tabView:gridNomLote :form:tabView:grid :form:tabView:idTableContrato" />
            <p:commandButton value="NO" oncomplete="PF('saveContra').hide()"/>
        </h:form>
    </p:confirmDialog>
    
    <p:confirmDialog widgetVar="deleteObsDialog" showEffect="fade" width="300" message="¿Deseas eliminar la observacion del contrato?" header="Confirmación" severity="warn" appendTo="@(body)">
        <p:commandButton value="Si" icon="pi pi-check" process="@this" update=":formAñadirObservacionDialog:idObsContrato" oncomplete="PF('deleteObsDialog').hide()" actionListener="#{contratoBean.deleteObs()}" />
        <p:commandButton value="No" type="button" styleClass="ui-button-secondary" icon="pi pi-times" onclick="PF('deleteObsDialog').hide()" />
    </p:confirmDialog>
	
	
	<script type="text/javascript">
        
        function hacerClick(elementName) {
            element = document.getElementById(elementName);
            element.click();
        }
        
        function mostrarSimulacion(xhr, status, args) {
            if (args.noEsValido) {
            	 PF('cronogramaDialog').show();
            }
        }
        
        function mostrarCronograma(xhr, status, args) {
            if (args.noEsValido) {
            	 PF('cronogramaPagoDialog').show();
            }
        }

    </script>


</ui:composition>